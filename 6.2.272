To: vim-dev@vim.org
Subject: Patch 6.2.272
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 6.2.272
Problem:    When the "po" directory exists, but "po/Makefile" doesn't,
	    building fails.  Make loops when the "po" directory has been
	    deleted after running configure.
Solution:   Check for the "po/Makefile" instead of just the "po" directory.
	    Check this again before trying to run make with that Makefile.
Files:	    src/auto/configure, src/configure.in, src/Makefile


*** ../vim-6.2.271/src/auto/configure	Wed Feb  4 12:12:05 2004
--- src/auto/configure	Tue Feb 17 17:25:57 2004
***************
*** 7666,7684 ****
  fi
  
    echo $ac_n "checking for NLS""... $ac_c" 1>&6
! echo "configure:7429: checking for NLS" >&5
!   if test -d po; then
      have_gettext="no"
      if test -n "$MSGFMT"; then
        cat > conftest.$ac_ext <<EOF
! #line 7434 "configure"
  #include "confdefs.h"
  #include <libintl.h>
  int main() {
  gettext("Test");
  ; return 0; }
  EOF
! if { (eval echo configure:7441: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
    rm -rf conftest*
    echo "$ac_t""gettext() works" 1>&6; have_gettext="yes"
  else
--- 7669,7687 ----
  fi
  
    echo $ac_n "checking for NLS""... $ac_c" 1>&6
! echo "configure:7673: checking for NLS" >&5
!   if test -f po/Makefile; then
      have_gettext="no"
      if test -n "$MSGFMT"; then
        cat > conftest.$ac_ext <<EOF
! #line 7678 "configure"
  #include "confdefs.h"
  #include <libintl.h>
  int main() {
  gettext("Test");
  ; return 0; }
  EOF
! if { (eval echo configure:7685: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
    rm -rf conftest*
    echo "$ac_t""gettext() works" 1>&6; have_gettext="yes"
  else
*** ../vim-6.2.271/src/configure.in	Wed Feb  4 12:12:05 2004
--- src/configure.in	Tue Feb 17 17:25:03 2004
***************
*** 2475,2481 ****
    AC_MSG_RESULT(no)
    AC_CHECK_PROG(MSGFMT, msgfmt, msgfmt, )
    AC_MSG_CHECKING([for NLS])
!   if test -d po; then
      have_gettext="no"
      if test -n "$MSGFMT"; then
        AC_TRY_LINK(
--- 2475,2481 ----
    AC_MSG_RESULT(no)
    AC_CHECK_PROG(MSGFMT, msgfmt, msgfmt, )
    AC_MSG_CHECKING([for NLS])
!   if test -f po/Makefile; then
      have_gettext="no"
      if test -n "$MSGFMT"; then
        AC_TRY_LINK(
***************
*** 2509,2515 ****
  		AC_MSG_RESULT([no]))
      fi
    else
!     AC_MSG_RESULT([no "po" directory - disabled]);
    fi
  else
    AC_MSG_RESULT(yes)
--- 2509,2515 ----
  		AC_MSG_RESULT([no]))
      fi
    else
!     AC_MSG_RESULT([no "po/Makefile" - disabled]);
    fi
  else
    AC_MSG_RESULT(yes)
*** ../vim-6.2.271/src/Makefile	Mon Jan 12 19:56:01 2004
--- src/Makefile	Tue Feb 17 21:13:56 2004
***************
*** 1494,1503 ****
  # Build the language specific files if they were unpacked.
  # Generate the converted .mo files separately, it's no problem if this fails.
  languages:
! 	@if test -n "$(MAKEMO)"; then \
  		cd $(PODIR); CC="$(CC)" $(MAKE) prefix=$(DESTDIR)$(prefix); \
  	fi
! 	-@if test -n "$(MAKEMO)"; then \
  		cd $(PODIR); CC="$(CC)" $(MAKE) prefix=$(DESTDIR)$(prefix) converted; \
  	fi
  
--- 1500,1509 ----
  # Build the language specific files if they were unpacked.
  # Generate the converted .mo files separately, it's no problem if this fails.
  languages:
! 	@if test -n "$(MAKEMO)" -a -f $(PODIR)/Makefile; then \
  		cd $(PODIR); CC="$(CC)" $(MAKE) prefix=$(DESTDIR)$(prefix); \
  	fi
! 	-@if test -n "$(MAKEMO)" -a -f $(PODIR)/Makefile; then \
  		cd $(PODIR); CC="$(CC)" $(MAKE) prefix=$(DESTDIR)$(prefix) converted; \
  	fi
  
***************
*** 1765,1771 ****
  
  # install the language specific files, if they were unpacked
  install-languages: languages $(DEST_LANG) $(DEST_KMAP)
! 	if test -n "$(MAKEMO)"; then \
  	   cd $(PODIR); $(MAKE) prefix=$(DESTDIR)$(prefix) LOCALEDIR=$(DEST_LANG) \
  	   INSTALL_DATA=$(INSTALL_DATA) FILEMOD=$(FILEMOD) install; \
  	fi
--- 1771,1777 ----
  
  # install the language specific files, if they were unpacked
  install-languages: languages $(DEST_LANG) $(DEST_KMAP)
! 	if test -n "$(MAKEMO)" -a -f $(PODIR)/Makefile; then \
  	   cd $(PODIR); $(MAKE) prefix=$(DESTDIR)$(prefix) LOCALEDIR=$(DEST_LANG) \
  	   INSTALL_DATA=$(INSTALL_DATA) FILEMOD=$(FILEMOD) install; \
  	fi
*** ../vim-6.2.271/src/version.c	Thu Feb 19 14:43:37 2004
--- src/version.c	Thu Feb 19 14:46:02 2004
***************
*** 639,640 ****
--- 639,642 ----
  {   /* Add new patch number below this line */
+ /**/
+     272,
  /**/

-- 
A bad peace is better than a good war. - Yiddish Proverb

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        Sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\              Project leader for A-A-P -- http://www.A-A-P.org        ///
 \\\  Help AIDS victims, buy here: http://ICCF-Holland.org/click1.html  ///
